name: Agent Intake

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  intake:
    runs-on: ubuntu-latest
    # Only process issues from trusted actors
    if: |
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.issue.author_association) &&
      contains(github.event.issue.body, '<!-- agent-request -->') &&
      !contains(github.event.issue.body, '<!-- agent-task -->') &&
      !contains(github.event.issue.body, '<!-- agent-probe -->')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load configuration
        id: config
        run: |
          # Read config.yml and extract key values
          BOT_ASSIGNEE=$(yq eval '.copilot.bot_assignee' .github/agent/config.yml)
          BASE_BRANCH=$(yq eval '.copilot.base_branch' .github/agent/config.yml)
          SPEC_DIR=$(yq eval '.paths.spec_dir' .github/agent/config.yml)
          LABEL_SPEC_IN_PROGRESS=$(yq eval '.labels.parent.spec_in_progress' .github/agent/config.yml)
          
          echo "bot_assignee=$BOT_ASSIGNEE" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "spec_dir=$SPEC_DIR" >> $GITHUB_OUTPUT
          echo "label_spec_in_progress=$LABEL_SPEC_IN_PROGRESS" >> $GITHUB_OUTPUT

      - name: Initialize state
        uses: actions/github-script@v7
        env:
          AGENT_GH_TOKEN: ${{ secrets.AGENT_GH_TOKEN }}
        with:
          github-token: ${{ secrets.AGENT_GH_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const stateMarker = '<!-- agent-state:json -->';
            
            // Create initial state
            const initialState = {
              state_id: `agent-state:${context.repo.owner}/${context.repo.repo}:${issueNumber}`,
              version: 1,
              parent_issue: issueNumber,
              plan_path: null,
              cursor_task_id: null,
              tasks: {},
              paused: false,
              phase: 'spec-in-progress',
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString()
            };
            
            // Create state comment
            const stateComment = [
              stateMarker,
              '```json',
              JSON.stringify(initialState, null, 2),
              '```',
              '',
              'Agent State Initialized',
              '',
              'This comment tracks the execution state of the autonomous agent. Do not edit manually.'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: stateComment
            });
            
            core.info(`‚úì State initialized for issue #${issueNumber}`);

      - name: Add labels
        uses: actions/github-script@v7
        env:
          AGENT_GH_TOKEN: ${{ secrets.AGENT_GH_TOKEN }}
        with:
          github-token: ${{ secrets.AGENT_GH_TOKEN }}
          script: |
            const label = '${{ steps.config.outputs.label_spec_in_progress }}';
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });
            
            core.info(`‚úì Added label: ${label}`);

      - name: Assign to Copilot
        uses: actions/github-script@v7
        env:
          AGENT_GH_TOKEN: ${{ secrets.AGENT_GH_TOKEN }}
        with:
          github-token: ${{ secrets.AGENT_GH_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const botAssignee = '${{ steps.config.outputs.bot_assignee }}';
            const baseBranch = '${{ steps.config.outputs.base_branch }}';
            const specDir = '${{ steps.config.outputs.spec_dir }}';
            const repoFullName = `${context.repo.owner}/${context.repo.repo}`;
            
            // Custom instructions for Copilot to generate Spec
            const customInstructions = `
# Task: Generate Chinese Specification Document

Please create a detailed Chinese specification document based on this requirement issue.

## Requirements:
1. Create a new file at: \`${specDir}/issue-${issueNumber}.md\`
2. Follow the template structure from \`docs/agent/SPEC_TEMPLATE.md\`
3. Include all sections: ËÉåÊôØ‰∏éÁõÆÊ†á, ËåÉÂõ¥, Áî®Êà∑ÊïÖ‰∫ã, È™åÊî∂Ê†áÂáÜ, È£éÈô©‰∏éÂõûÊªö, ÈùûÁõÆÊ†á
4. Write in Chinese (‰∏≠Êñá)
5. Be specific and detailed based on the issue description

## PR Requirements:
1. Create a PR with the spec document
2. PR title: "[Spec] Issue #${issueNumber}: <brief description>"
3. **IMPORTANT**: PR body MUST include these markers:
   \`\`\`
   Agent-Parent-Issue: ${issueNumber}
   Agent-Task-Id: spec
   \`\`\`
4. Target branch: ${baseBranch}

## Notes:
- Focus on clarity and completeness
- Ensure all acceptance criteria are measurable
- Identify risks and mitigation strategies
`.trim();
            
            try {
              // Assign issue to Copilot with custom instructions
              const response = await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                assignees: [botAssignee],
                agent_assignment: {
                  target_repo: repoFullName,
                  base_branch: baseBranch,
                  custom_instructions: customInstructions,
                  custom_agent: '',
                  model: ''
                }
              });
              
              core.info(`‚úì Assigned issue #${issueNumber} to ${botAssignee}`);
              
              // Add comment to notify user
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ü§ñ **Agent Started**\n\nI've assigned this issue to ${botAssignee} to generate a Chinese specification document.\n\n**Next Steps:**\n1. Copilot will create a Spec PR within ${process.env.SPEC_TIMEOUT || 20} minutes\n2. Review and approve the Spec PR\n3. After merge, the system will automatically generate a Plan\n\n**Status:** \`spec-in-progress\``
              });
              
            } catch (error) {
              core.setFailed(`Failed to assign to Copilot: ${error.message}`);
              
              // Add blocked label and comment
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['agent:blocked']
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `‚ùå **Agent Blocked**\n\nFailed to assign issue to Copilot.\n\n**Error:** ${error.message}\n\n**Possible causes:**\n- \`AGENT_GH_TOKEN\` secret is missing or has insufficient permissions\n- Copilot coding agent is not enabled for this repository\n- API rate limit exceeded\n\nPlease check the workflow logs and repository settings.`
              });
              
              throw error;
            }
