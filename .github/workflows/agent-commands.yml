name: Agent Commands

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  handle-command:
    runs-on: ubuntu-latest
    if: |
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association) &&
      (startsWith(github.event.comment.body, '/approve-task') ||
       startsWith(github.event.comment.body, '/pause') ||
       startsWith(github.event.comment.body, '/resume') ||
       startsWith(github.event.comment.body, '/retry') ||
       startsWith(github.event.comment.body, '/abort'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install js-yaml

      - name: Parse command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.trim();
            const commandLine = comment.split('\n')[0].trim();
            
            let command = null;
            if (commandLine === '/approve-task') command = 'approve-task';
            else if (commandLine === '/pause') command = 'pause';
            else if (commandLine === '/resume') command = 'resume';
            else if (commandLine === '/retry') command = 'retry';
            else if (commandLine === '/abort') command = 'abort';
            
            core.setOutput('command', command || '');
            return command;

      - name: Handle approve-task
        if: steps.parse.outputs.command == 'approve-task'
        uses: actions/github-script@v7
        env:
          AGENT_GH_TOKEN: ${{ secrets.AGENT_GH_TOKEN }}
        with:
          github-token: ${{ secrets.AGENT_GH_TOKEN }}
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');
            const config = yaml.load(fs.readFileSync('.github/agent/config.yml', 'utf8'));
            
            const issue = context.payload.issue;
            const isPR = !!issue.pull_request;
            
            if (!isPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚ùå `/approve-task` can only be used on pull requests.'
              });
              return;
            }
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue.number
            });
            
            const labels = pr.labels.map(l => l.name);
            if (!labels.includes(config.labels.level.l2)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚ùå `/approve-task` can only be used on L2 task PRs.'
              });
              return;
            }
            
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const ciCheck = checks.check_runs.find(c => c.name === config.ci.required_check_name);
            if (!ciCheck || ciCheck.conclusion !== 'success') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚ùå Cannot approve: CI checks have not passed yet.'
              });
              return;
            }
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: issue.number,
                merge_method: 'squash'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚úÖ **Task Approved and Merged**\n\nApproved by @${context.payload.comment.user.login}`
              });
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚ùå **Merge Failed**\n\n${error.message}`
              });
            }

      - name: Handle pause/resume/abort
        if: steps.parse.outputs.command == 'pause' || steps.parse.outputs.command == 'resume' || steps.parse.outputs.command == 'abort'
        uses: actions/github-script@v7
        env:
          AGENT_GH_TOKEN: ${{ secrets.AGENT_GH_TOKEN }}
        with:
          github-token: ${{ secrets.AGENT_GH_TOKEN }}
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');
            const config = yaml.load(fs.readFileSync('.github/agent/config.yml', 'utf8'));
            const command = '${{ steps.parse.outputs.command }}';
            const issue = context.payload.issue;
            
            if (command === 'pause') {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [config.labels.parent.paused]
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚è∏Ô∏è **Agent Paused**\n\nTask dispatch paused by @${context.payload.comment.user.login}.\n\nUse \`/resume\` to continue.`
              });
            } else if (command === 'resume') {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: config.labels.parent.paused
              }).catch(() => {});
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚ñ∂Ô∏è **Agent Resumed**\n\nTask dispatch resumed by @${context.payload.comment.user.login}.`
              });
              
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'agent-task-dispatcher.yml',
                ref: context.ref,
                inputs: {
                  parent_issue: issue.number.toString(),
                  trigger: 'resume'
                }
              });
            } else if (command === 'abort') {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [config.labels.parent.blocked]
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `üõë **Agent Aborted**\n\nPipeline aborted by @${context.payload.comment.user.login}.`
              });
            }
