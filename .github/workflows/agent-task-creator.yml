name: Agent Task Creator

on:
  workflow_dispatch:
    inputs:
      parent_issue:
        description: 'Parent issue number'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-tasks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install js-yaml @octokit/rest

      - name: Create task issues
        uses: actions/github-script@v7
        env:
          AGENT_GH_TOKEN: ${{ secrets.AGENT_GH_TOKEN }}
        with:
          github-token: ${{ secrets.AGENT_GH_TOKEN }}
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');
            const issueNumber = parseInt('${{ inputs.parent_issue }}');
            
            const config = yaml.load(fs.readFileSync('.github/agent/config.yml', 'utf8'));
            const planPath = `${config.paths.plan_yaml_dir}/issue-${issueNumber}.yaml`;
            
            if (!fs.existsSync(planPath)) {
              core.setFailed(`Plan file not found: ${planPath}`);
              return;
            }
            
            const plan = yaml.load(fs.readFileSync(planPath, 'utf8'));
            
            if (!plan.tasks || plan.tasks.length === 0) {
              core.setFailed('No tasks found in plan');
              return;
            }
            
            const existingIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: config.labels.task.task,
              state: 'all',
              per_page: 100
            });
            
            const taskIssueMap = new Map();
            for (const issue of existingIssues) {
              const body = issue.body || '';
              const parentMatch = body.match(/Agent-Parent-Issue:\s*(\d+)/);
              const taskMatch = body.match(/Agent-Task-Id:\s*(\S+)/);
              
              if (parentMatch && taskMatch && parseInt(parentMatch[1]) === issueNumber) {
                taskIssueMap.set(taskMatch[1], issue.number);
              }
            }
            
            const createdIssues = [];
            
            for (const task of plan.tasks) {
              let taskIssueNumber = taskIssueMap.get(task.id);
              
              if (!taskIssueNumber) {
                const issueBody = [
                  '<!-- agent-task -->',
                  '',
                  'Parent Issue: #' + issueNumber,
                  'Task ID: `' + task.id + '`',
                  'Level: `' + task.level + '`',
                  'Plan: `' + planPath + '`',
                  '',
                  '## Task Description',
                  '',
                  task.title,
                  '',
                  '## Acceptance Criteria',
                  '',
                  task.acceptance || 'See plan file for details',
                  '',
                  '## Dependencies',
                  '',
                  task.deps && task.deps.length > 0 ? task.deps.map(d => '- ' + d).join('\n') : 'None',
                  '',
                  '## Notes',
                  '',
                  task.notes || 'None',
                  '',
                  '---',
                  '',
                  'Agent-Parent-Issue: ' + issueNumber,
                  'Agent-Task-Id: ' + task.id
                ].join('\n');
                
                const newIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[Task ${task.id}] ${task.title}`,
                  body: issueBody,
                  labels: [
                    config.labels.task.task,
                    config.labels.task.pending,
                    config.labels.level[task.level]
                  ]
                });
                
                taskIssueNumber = newIssue.data.number;
                core.info(`✓ Created task issue #${taskIssueNumber} for ${task.id}`);
              } else {
                core.info(`✓ Task issue #${taskIssueNumber} already exists for ${task.id}`);
              }
              
              createdIssues.push({ taskId: task.id, issueNumber: taskIssueNumber });
              
              task.issue = taskIssueNumber;
            }
            
            fs.writeFileSync(planPath, yaml.dump(plan));
            
            const planMdPath = `${config.paths.plan_md_dir}/issue-${issueNumber}.md`;
            const planMd = `# 执行计划（Issue #${issueNumber}）

## 元信息

- **Parent Issue:** #${issueNumber}
- **总任务数:** ${plan.tasks.length}
- **最后更新:** ${new Date().toISOString()}

## 任务列表

| ID | Level | Status | Issue | PR | Acceptance |
|----|-------|--------|-------|----|-----------| 
${plan.tasks.map(t => `| ${t.id} | ${t.level} | ${t.status} | ${t.issue ? `#${t.issue}` : '-'} | ${t.pr ? `#${t.pr}` : '-'} | ${t.acceptance} |`).join('\n')}

## 任务详情

${plan.tasks.map(t => `### ${t.id}: ${t.title}

- **Level:** ${t.level}
- **Status:** ${t.status}
- **Issue:** ${t.issue ? `#${t.issue}` : 'Not created'}
- **PR:** ${t.pr ? `#${t.pr}` : 'Not created'}
- **Dependencies:** ${t.deps && t.deps.length > 0 ? t.deps.join(', ') : 'None'}

**Acceptance Criteria:**
${t.acceptance}

${t.notes ? `**Notes:**\n${t.notes}` : ''}
`).join('\n---\n\n')}
`;
            
            fs.writeFileSync(planMdPath, planMd);
            
            core.info('Creating status update PR...');

      - name: Create status update PR
        uses: actions/github-script@v7
        env:
          AGENT_GH_TOKEN: ${{ secrets.AGENT_GH_TOKEN }}
        with:
          github-token: ${{ secrets.AGENT_GH_TOKEN }}
          script: |
            const issueNumber = parseInt('${{ inputs.parent_issue }}');
            const fs = require('fs');
            const yaml = require('js-yaml');
            
            const config = yaml.load(fs.readFileSync('.github/agent/config.yml', 'utf8'));
            const branchName = `agent/plan-status/${issueNumber}/link-issues`;
            const baseBranch = config.copilot.base_branch;
            
            const { data: baseRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${baseBranch}`
            });
            
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: baseRef.object.sha
              });
            } catch (e) {
              await github.rest.git.updateRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchName}`,
                sha: baseRef.object.sha,
                force: true
              });
            }
            
            const planYamlPath = `${config.paths.plan_yaml_dir}/issue-${issueNumber}.yaml`;
            const planMdPath = `${config.paths.plan_md_dir}/issue-${issueNumber}.md`;
            
            const yamlContent = fs.readFileSync(planYamlPath, 'utf8');
            const mdContent = fs.readFileSync(planMdPath, 'utf8');
            
            const yamlBlob = await github.rest.git.createBlob({
              owner: context.repo.owner,
              repo: context.repo.repo,
              content: Buffer.from(yamlContent).toString('base64'),
              encoding: 'base64'
            });
            
            const mdBlob = await github.rest.git.createBlob({
              owner: context.repo.owner,
              repo: context.repo.repo,
              content: Buffer.from(mdContent).toString('base64'),
              encoding: 'base64'
            });
            
            const { data: baseTree } = await github.rest.git.getTree({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tree_sha: baseRef.object.sha
            });
            
            const { data: newTree } = await github.rest.git.createTree({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base_tree: baseTree.sha,
              tree: [
                {
                  path: planYamlPath,
                  mode: '100644',
                  type: 'blob',
                  sha: yamlBlob.data.sha
                },
                {
                  path: planMdPath,
                  mode: '100644',
                  type: 'blob',
                  sha: mdBlob.data.sha
                }
              ]
            });
            
            const { data: commit } = await github.rest.git.createCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              message: `chore(agent): link task issues to plan #${issueNumber}`,
              tree: newTree.sha,
              parents: [baseRef.object.sha]
            });
            
            await github.rest.git.updateRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${branchName}`,
              sha: commit.sha
            });
            
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });
            
            if (existingPRs.data.length === 0) {
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[agent-status] Update plan with task issues #${issueNumber}`,
                head: branchName,
                base: baseBranch,
                body: `Agent-Parent-Issue: ${issueNumber}\nAgent-Task-Id: status-link-issues\n\nAutomatically generated PR to link task issues to plan.`
              });
              
              core.info('✓ Created status update PR');
            } else {
              core.info('✓ Status update PR already exists');
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `✅ **Task Issues Created**\n\nCreated ${plan.tasks.length} task sub-issues. A status update PR has been created to link them to the plan.\n\n**Next:** The first task will be assigned to Copilot once the status PR is merged.`
            });
