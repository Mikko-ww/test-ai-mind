name: Agent CI

on:
  workflow_dispatch:
    inputs:
      pr_number:
        required: true
        type: string
      head_sha:
        required: true
        type: string
      head_ref:
        required: true
        type: string

permissions:
  contents: read
  checks: write
  pull-requests: read

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.head_ref }}
          
      - name: Verify PR head SHA
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          if [ "$CURRENT_SHA" != "${{ inputs.head_sha }}" ]; then
            echo "Error: HEAD SHA mismatch"
            echo "Expected: ${{ inputs.head_sha }}"
            echo "Got: $CURRENT_SHA"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm install
          fi

      - name: Run lint
        id: lint
        continue-on-error: true
        run: |
          if [ -f package.json ] && npm run lint --if-present; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=skipped" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        id: test
        continue-on-error: true
        run: |
          if [ -f package.json ] && npm test --if-present; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=skipped" >> $GITHUB_OUTPUT
          fi

      - name: Create check run
        uses: actions/github-script@v7
        with:
          script: |
            const lintResult = '${{ steps.lint.outputs.result }}';
            const testResult = '${{ steps.test.outputs.result }}';
            
            let conclusion = 'success';
            let summary = '✅ All checks passed';
            
            if (lintResult === 'failure' || testResult === 'failure') {
              conclusion = 'failure';
              summary = '❌ Some checks failed';
            }
            
            const output = {
              title: 'Agent CI Results',
              summary: summary,
              text: `**Lint**: ${lintResult}\n**Tests**: ${testResult}`
            };
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'agent/ci',
              head_sha: '${{ inputs.head_sha }}',
              status: 'completed',
              conclusion: conclusion,
              output: output
            });
