# ============================================================================
# Agent Merge Policy Workflow - 代理合并策略工作流
# ============================================================================
#
# 【工作流用途】
# 这个工作流负责评估 Task PR 的风险级别，并根据合并策略决定是否自动合并。
# 它实现了基于文件路径的风险分级系统，确保安全的代码自动合并。
#
# 【触发方式】
# - 手动触发（workflow_dispatch）：由其他工作流调用
# - 需要提供参数：PR 编号、父 Issue 编号、任务 ID
#
# 【风险级别】
# - L1（低风险）：文档、测试、Markdown 文件 → 自动合并
# - L2（中等风险）：应用代码、非敏感文件 → 需要 /approve-task 命令
# - L3（高风险）：工作流、配置、敏感文件 → 需要完整的人工审查
#
# 【主要功能】
# 1. 评估合并策略：分析 PR 修改的文件，确定风险级别
# 2. 检查文件路径：
#    - 匹配 allowlist_globs（白名单）→ L1
#    - 匹配 sensitive_globs（敏感文件）→ L3
#    - 其他文件 → L2
# 3. 自动合并 L1：如果是低风险，启用自动合并
# 4. 添加标签：为 PR 添加相应的风险级别标签
#
# 【工作流程】
# 1. Task PR 通过 CI 验证后触发此工作流
# 2. 读取配置文件中的合并策略规则
# 3. 分析 PR 中修改的所有文件
# 4. 根据文件路径匹配规则确定风险级别
# 5. 如果是 L1，启用 GitHub 自动合并功能
# 6. 如果是 L2/L3，等待人工审查
#
# 【配置示例】
# merge_policy:
#   l1:
#     allowlist_globs:
#       - "docs/**"
#       - "*.md"
#       - "tests/**"
#   sensitive_globs:
#     - ".github/workflows/**"
#     - "**/*.yml"
#
# 【使用场景】
# - Task PR 创建后自动评估风险
# - 决定是否需要人工审查
# - 加速低风险更改的合并
# - 保护关键文件不被自动合并
#
# ============================================================================

name: Agent Merge Policy
run-name: "Agent Merge Policy • PR #${{ inputs.pr_number }} • Task ${{ inputs.task_id }}"

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: number
      parent_issue:
        description: 'Parent issue number'
        required: true
        type: number
      task_id:
        description: 'Task ID'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: cd .github/scripts && npm install

      - name: Evaluate merge policy
        id: evaluate
        run: node .github/scripts/evaluate-merge-policy.js
        env:
          AGENT_GH_TOKEN: ${{ secrets.AGENT_GH_TOKEN }}
          PR_NUMBER: ${{ inputs.pr_number }}
          PARENT_ISSUE: ${{ inputs.parent_issue }}
          TASK_ID: ${{ inputs.task_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Enable auto-merge for L1
        if: steps.evaluate.outputs.can_auto_merge == 'true'
        run: node .github/scripts/auto-merge-l1.js
        env:
          AGENT_GH_TOKEN: ${{ secrets.AGENT_GH_TOKEN }}
          PR_NUMBER: ${{ inputs.pr_number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
