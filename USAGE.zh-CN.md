# 使用说明

本指南提供了有关如何使用 GitHub 自治代理系统来自动化开发工作流的分步说明。

---

## 📋 前提条件

开始之前，请确保您拥有以下权限和设置：

1.  **访问权限**：您必须是仓库的 **OWNER**（所有者）、**MEMBER**（成员）或 **COLLABORATOR**（协作者）。
2.  **Copilot**：仓库必须启用 GitHub Copilot。
3.  **标签**：确保代理标签（如 `agent:requested`、`agent:l1`）已存在。

---

## 🚀 工作流

工作流包含 5 个主要步骤：Issue → Spec → Plan → Implementation → Completion。

### 步骤 1：提交需求

1.  进入仓库的 **Issues** 标签页。
2.  点击 **New Issue** 并选择 **Agent Request** 模板。
3.  填写详细需求：
    *   **背景 (Background)**：为什么需要这个？
    *   **范围 (Scope)**：包含什么，不包含什么？
    *   **验收标准 (Acceptance Criteria)**：我们如何知道它完成了？
4.  点击 **Submit New Issue**。

> **结果**：代理将拾取该 Issue，标记为 `agent:spec-in-progress`，并指派 Copilot 编写规格说明书。

### 步骤 2：审查规格

1.  等待约 **20 分钟**。Copilot 将创建一个标题为 `[Spec] Issue #<id>...` 的 Pull Request (PR)。
2.  审查生成的 **中文规格说明书** (`docs/specs/issue-<id>.md`)。
3.  **操作**：
    *   如果正确：**合并 (Merge)** 该 PR。
    *   如果需要修改：在 PR 中评论或直接编辑文件，然后合并。

> **结果**：合并 Spec PR 将触发计划生成阶段 (`agent:plan-in-progress`)。

### 步骤 3：审查计划

1.  等待约 **20 分钟**。Copilot 将创建一个标题为 `[Plan] Issue #<id>...` 的 PR。
2.  审查 **计划** 文件 (`plans/issue-<id>.yaml` 和 `.md`)。
    *   检查任务拆分。
    *   检查风险等级 L1/L2/L3。
3.  **操作**：如果计划看起来不错，请 **合并 (Merge)** 该 PR。

> **结果**：合并 Plan PR 将触发为每个任务创建子 Issue 并开始执行。

### 步骤 4：监控执行

代理将 **串行**（一个接一个）执行任务。

1.  前往 **父 Issue**。您将看到包含当前状态 (JSON) 的评论。
2.  查找代理创建的子 Issue（例如 `Task 1: ...`）。
3.  代理将在这些子 Issue 上操作以生成实现代码。

### 步骤 5：审查与合并任务

Copilot 将为每个任务开启一个 PR。合并流程取决于 **风险等级**：

#### 🟢 L1: 低风险 (自动合并)
*   **标准**：仅触及文档、测试或白名单文件。
*   **操作**：无需操作。如果 CI 通过，将自动合并。

#### 🟡 L2: 中风险 (命令批准)
*   **标准**：触及逻辑代码但无敏感文件。
*   **操作**：
    1.  等待 CI 检查通过（绿色）。
    2.  在 PR 中评论 **/approve-task**。
    3.  代理将合并该 PR。

#### 🔴 L3: 高风险 (人工审查)
*   **标准**：触及工作流、密钥或大量更改（>300 个文件）。
*   **操作**：需要通过 GitHub UI 进行完整的人工审查和手动批准。

---

## 💬 ChatOps 命令

在 Issue 或 PR 的评论中使用这些命令。

| 命令 | 上下文 | 描述 |
| :--- | :--- | :--- |
| `/approve-task` | **PR only** | 批准并合并 L2 任务（需要 CI 通过）。 |
| `/pause` | **Issue/PR** | 暂停自动化调度器。 |
| `/resume` | **Issue/PR** | 暂停后恢复调度器。 |
| `/abort` | **Issue/PR** | 永久停止整个工作流。 |
| `/help` | **Issue/PR** | 显示帮助信息。 |

---

## ❓ 故障排除

*   **卡住了？**
    *   检查 PR 上的 **CI** 是否失败。修复代码并推送，或等待代理重试（如果支持）。
    *   检查父 Issue 是否被 **暂停** (`agent:paused`)。使用 `/resume`。
*   **未创建 PR？**
    *   请至少等待 **20-30 分钟**。Copilot 生成代码需要时间。
    *   检查 GitHub Actions 标签页是否有工作流失败。
